<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMP Report Database Schema (Option C) - Hybrid Best of Both Worlds</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagram-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            min-height: 700px;
        }
        h1, h2 {
            color: #333;
        }
        .mermaid {
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #fafafa;
            min-height: 600px;
            height: 600px;
            position: relative;
            overflow: hidden;
            display: block;
        }
        
        .mermaid svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .description {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.6;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .zoom-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .zoom-btn:hover {
            background: #1976D2;
        }
        .zoom-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 1000;
        }
        .highlight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .feature-card h3 {
            color: #2196F3;
            margin-top: 0;
        }
        .nav-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            margin: -20px -20px 20px -20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .nav-link.current {
            background: rgba(255, 255, 255, 0.4);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="nav-header">
        <h1 style="margin: 0; font-size: 1.8rem;">AMP Report Database Schema Options</h1>
        <div class="nav-links">
            <a href="index.html" class="nav-link">üè† Main Landing Page</a>
            <a href="database-schema-diagram-option-a.html" class="nav-link">üìä Schema Option A</a>
            <a href="database-schema-diagram-option-b.html" class="nav-link">üîí Schema Option B</a>
            <a href="database-schema-diagram-option-c.html" class="nav-link">üèÜ Schema Option C</a>
            <a href="database-schema-diagram-option-c-merged.html" class="nav-link current">üöÄ Schema Option C (Merged)</a>
        </div>
    </div>
    
    <div class="highlight-box">
        <h1>üèÜ AMP Report Database Schema (Option C) - Hybrid Best of Both Worlds</h1>
        <p style="font-size: 18px; margin-bottom: 10px;">
            <strong>Ultimate synthesis of enterprise-grade features and technical excellence</strong>
        </p>
        <p style="font-size: 16px; opacity: 0.9;">
            Combining Option A's comprehensive organizational capabilities with Option B's elegant immutability and geographic intelligence, 
            plus innovative enhancements for industry leadership. Features 40+ tables across 9 business domains with multi-stakeholder 
            support, immutable audit trails, and advanced geographic cost intelligence.
        </p>
    </div>

    <div class="feature-grid">
        <div class="feature-card">
            <h3>üè¢ Ultimate Multi-Tenant Architecture</h3>
            <p>Complete organizations + Row-Level Security with multi-stakeholder isolation and buyer scenarios</p>
        </div>
        <div class="feature-card">
            <h3>üåç Superior Geographic Intelligence</h3>
            <p>Hierarchical geo_regions with LTREE, immutable datasets, and automatic regional fallback</p>
        </div>
        <div class="feature-card">
            <h3>üè† Comprehensive Property Management</h3>
            <p>All detailed submission tables from Option A with enhanced JSONB flexibility</p>
        </div>
        <div class="feature-card">
            <h3>üîí Advanced Immutability Framework</h3>
            <p>Locked datasets and reports with complete audit trails and version control</p>
        </div>
    </div>
    
    <div class="diagram-container">
        <h2>Complete Schema Entity Relationship Diagram</h2>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn('schema-erd')">+</button>
            <button class="zoom-btn" onclick="zoomOut('schema-erd')">-</button>
            <button class="zoom-btn" onclick="resetZoom('schema-erd')">Reset</button>
        </div>
        <div class="zoom-info">Use mouse wheel to zoom, drag to pan</div>
        <div class="mermaid" id="schema-erd">
erDiagram
    %% Organization & User Management
    users ||--o{ organization_members : "belongs to"
    organizations ||--o{ organization_members : "has members"
    users ||--o{ property_submissions : "creates"
    organizations ||--o{ submission_sharing : "can access"
    property_submissions ||--o{ submission_sharing : "can be shared"
    
    %% Geographic & Pricing
    geo_regions ||--o{ geo_regions : "parent_id"
    geo_regions ||--o{ cost_datasets : "geo_region_id"
    geo_regions ||--o{ properties : "geo_region_id"
    cost_datasets ||--o{ cost_prices : "dataset_id"
    cost_datasets ||--o{ regional_multipliers : "dataset_id"
    
    %% Property Management
    properties ||--o{ property_submissions : "has submissions"
    property_submissions ||--|| submission_details : "has details"
    property_submissions ||--|| submission_exterior_details : "has exterior"
    property_submissions ||--o{ submission_exterior_materials : "has materials"
    property_submissions ||--o{ submission_unit_access : "has access types"
    property_submissions ||--o{ submission_elevators : "has elevators"
    property_submissions ||--|| submission_units : "has unit summary"
    submission_units ||--o{ submission_unit_configs : "has configurations"
    property_submissions ||--o{ submission_amenities : "has amenities"
    
    %% Master Cost Data
    cost_categories ||--o{ cost_categories : "parent_id"
    cost_categories ||--o{ cost_subcategories : "contains"
    cost_subcategories ||--o{ cost_items : "contains"
    cost_items ||--|| cost_item_standards : "has standards"
    cost_items ||--o{ cost_item_attributes : "has attributes"
    cost_items ||--o{ cost_prices : "has prices"
    budget_tiers ||--o{ cost_prices : "defines"
    
    %% Bundle & Amenity System
    cost_bundles ||--o{ cost_bundle_items : "contains"
    cost_items ||--o{ cost_bundle_items : "included in"
    amenity_master ||--o{ amenity_conditions : "has conditions"
    amenity_master ||--o{ submission_amenities : "referenced by"
    amenity_conditions ||--o{ submission_amenities : "referenced by"
    amenity_master ||--o{ amenity_cost_items : "has cost items"
    amenity_conditions ||--o{ amenity_cost_items : "uses"
    cost_items ||--o{ amenity_cost_items : "linked to"
    
    %% Report Generation
    property_submissions ||--o{ reports : "generates"
    report_types ||--o{ reports : "defines"
    reports ||--o{ report_sections : "contains"
    report_sections ||--o{ report_line_items : "has items"
    reports ||--|| report_summary : "has summary"
    reports ||--o{ report_section_totals : "has totals"
    reports ||--o{ report_area_breakdown : "has breakdown"
    reports ||--o{ report_adjustments : "can have"
    reports ||--o{ report_documents : "produces"
    cost_items ||--o{ report_line_items : "referenced in"
    cost_bundles ||--o{ report_line_items : "referenced in"
    
    %% File Management & Analytics
    property_submissions ||--o{ submission_attachments : "has files"
    reports ||--o{ report_analytics : "tracked by"
    reports ||--o{ calculation_performance : "monitored by"
    cost_datasets ||--o{ cost_data_imports : "created by"
    
    %% Core Tables with Key Fields
    users {
        uuid id PK
        text clerk_id UK
        text email
        text first_name
        text last_name
        text phone
        text company
        uuid preferred_organization_id FK
        json settings
        timestamp last_active_at
    }
    
    organizations {
        uuid id PK
        text name
        text display_name
        json settings
        text subscription_tier
        boolean is_active
    }
    
    geo_regions {
        uuid id PK
        enum region_type
        text code
        text name
        uuid parent_id FK
        int depth
        ltree path
    }
    
    cost_datasets {
        uuid id PK
        uuid geo_region_id FK
        text label
        date effective_date
        date expiry_date
        char currency
        int version
        boolean is_active
        timestamp locked_at
    }
    
    properties {
        uuid id PK
        text address_line1
        text address_line2
        text city
        text state
        text zip
        text normalized_address UK
        decimal lat
        decimal lon
        uuid geo_region_id FK
        enum property_type
    }
    
    property_submissions {
        uuid id PK
        uuid property_id FK
        uuid submitted_by_user_id FK
        enum owner_type
        uuid owner_id
        text submission_number
        int version
        enum status
        text buyer_scenario_id
        uuid locked_dataset_id FK
        timestamp submitted_at
    }
    
    cost_items {
        uuid id PK
        uuid subcategory_id FK
        text code UK
        text name
        text unit_of_measure
        enum item_type
        int version
        boolean is_active
    }
    
    cost_prices {
        uuid item_id FK
        uuid dataset_id FK
        enum budget_tier
        enum cost_type
        decimal unit_cost
        timestamp locked_at
        uuid locked_by FK
    }
    
    reports {
        uuid id PK
        uuid submission_id FK
        uuid report_type_id FK
        text report_number
        int version
        uuid dataset_snapshot_id FK
        uuid buyer_user_id FK
        enum status
        timestamp locked_at
        uuid locked_by FK
        boolean is_final
    }
    
    report_line_items {
        uuid id PK
        uuid section_id FK
        uuid cost_item_id FK
        uuid source_bundle_id FK
        text description
        decimal quantity
        text unit_of_measure
        decimal unit_price
        enum budget_level
        decimal ffe_amount
        decimal labor_amount
        decimal material_amount
        decimal subtotal
        json calculation_metadata
    }
        </div>
        <div class="description">
            <strong>Complete Schema ERD:</strong> This comprehensive entity relationship diagram shows all 40+ tables and their relationships in the AMP Report Option C system. 
            Key architectural features include:
            <ul>
                <li><strong>Hybrid Multi-Tenant Architecture:</strong> Users can work independently or as part of multiple organizations with role-based permissions plus multi-stakeholder support</li>
                <li><strong>Geographic Intelligence:</strong> Hierarchical geo_regions with LTREE paths for efficient cost dataset resolution</li>
                <li><strong>Immutable Cost Engine:</strong> Cost datasets and reports become immutable once locked, ensuring audit trail integrity</li>
                <li><strong>Comprehensive Property Management:</strong> All detailed submission tables from Option A with enhanced JSONB flexibility</li>
                <li><strong>Advanced Bundle System:</strong> Cost bundles with dynamic formulas and condition-based amenity pricing</li>
                <li><strong>Flexible Report Generation:</strong> Multiple report types with immutable snapshots and complete calculation metadata</li>
                <li><strong>Performance Optimization:</strong> Pre-calculated totals, strategic denormalization, and comprehensive analytics</li>
            </ul>
        </div>
    </div>

    <div class="diagram-container">
        <h2>Data Aggregation Flow for UI View</h2>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn('data-flow')">+</button>
            <button class="zoom-btn" onclick="zoomOut('data-flow')">-</button>
            <button class="zoom-btn" onclick="resetZoom('data-flow')">Reset</button>
        </div>
        <div class="zoom-info">Use mouse wheel to zoom, drag to pan</div>
        <div class="mermaid" id="data-flow">
flowchart TB
    subgraph "User Selection"
        U[User/Organization] --> PS[Select Property Submission]
        PS --> BS[Select Buyer Scenario]
    end
    
    subgraph "Geographic Resolution"
        BS --> GR[Geographic Region Lookup]
        GR --> CD[Locked Cost Dataset]
        CD --> RM[Regional Multipliers]
    end
    
    subgraph "Core Submission Data"
        PS --> PD[Property Details]
        PS --> SD[Submission Details]
        PS --> SED[Exterior Details]
        PS --> SU[Unit Summary]
        PS --> SA[Amenities Selected]
    end
    
    subgraph "Master Cost Data Lookup"
        SA --> AM[Amenity Master]
        AM --> AC[Amenity Conditions]
        AM --> ACI[Amenity Cost Items]
        
        SED --> CI[Cost Items]
        SD --> CI
        SU --> CI
        
        CI --> CIS[Cost Item Standards]
        CD --> CP[Cost Prices by Budget Tier]
        CI --> CB[Cost Bundles]
    end
    
    subgraph "Report Generation Engine"
        SD --> VAS[Value Add Strategy]
        VAS --> RGE{Report Generation<br/>Engine}
        
        PD --> RGE
        SED --> RGE
        SA --> RGE
        SU --> RGE
        CI --> RGE
        CIS --> RGE
        CP --> RGE
        CB --> RGE
        RM --> RGE
        
        RGE --> BT[Apply Budget Tier]
        RGE --> CT[Apply Calculation Templates]
        RGE --> CCR[Apply Business Rules]
    end
    
    subgraph "Report Structure"
        RGE --> R[Immutable Report Record]
        R --> RS1[Amenities Section]
        R --> RS2[Units Section]
        R --> RS3[Exterior Section]
        R --> RS4[General Property Section]
        
        RS1 --> RLI1[Line Items with Locked Costs]
        RS2 --> RLI2[Line Items with Locked Costs]
        RS3 --> RLI3[Line Items with Locked Costs]
        RS4 --> RLI4[Line Items with Locked Costs]
        
        RLI1 --> RST[Pre-calculated Section Totals]
        RLI2 --> RST
        RLI3 --> RST
        RLI4 --> RST
        
        RST --> RAB[Area Breakdown]
        RAB --> RSM[Report Summary with ROI]
    end
    
    subgraph "UI Presentation"
        RSM --> PDF[PDF Report View]
        RAB --> CHART[Cost Breakdown Charts]
        RS1 --> TABLE1[Detailed Tables]
        RS2 --> TABLE2[Detailed Tables]
        RS3 --> TABLE3[Detailed Tables]
        RS4 --> TABLE4[Detailed Tables]
        
        PDF --> UI[Unified UI View]
        CHART --> UI
        TABLE1 --> UI
        TABLE2 --> UI
        TABLE3 --> UI
        TABLE4 --> UI
    end
    
    style U fill:#e1f5fe
    style PS fill:#e1f5fe
    style BS fill:#e8f5e8
    style RGE fill:#fff3e0
    style R fill:#c8e6c9
    style UI fill:#fce4ec
    style RSM fill:#ffecb3
        </div>
        <div class="description">
            <strong>Data Aggregation Flow:</strong> This diagram shows how data flows from user selection through to the final UI presentation in Option C:
            <ol>
                <li><strong>User Selection:</strong> User (solo or via organization) selects a property submission and buyer scenario</li>
                <li><strong>Geographic Resolution:</strong> System resolves geographic region and locks to specific cost dataset</li>
                <li><strong>Core Data Retrieval:</strong> All submission-related data is fetched including detailed property characteristics</li>
                <li><strong>Cost Lookup:</strong> Master cost data retrieved from locked dataset with regional multipliers applied</li>
                <li><strong>Report Generation:</strong> Engine applies business rules, calculation templates, and bundle formulas</li>
                <li><strong>Report Structure:</strong> Data organized into immutable sections with pre-calculated totals</li>
                <li><strong>UI Presentation:</strong> Multiple views generated for comprehensive analysis with buyer scenario isolation</li>
            </ol>
        </div>
    </div>

    <div class="diagram-container">
        <h2>Multi-Stakeholder Access Control & Geographic Intelligence</h2>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn('multi-stakeholder')">+</button>
            <button class="zoom-btn" onclick="zoomOut('multi-stakeholder')">-</button>
            <button class="zoom-btn" onclick="resetZoom('multi-stakeholder')">Reset</button>
        </div>
        <div class="zoom-info">Use mouse wheel to zoom, drag to pan</div>
        <div class="mermaid" id="multi-stakeholder">
flowchart TD
    %% Property & Geographic Context
    A[Property Address] --> B[Geographic Resolution]
    B --> C[geo_regions Hierarchy<br/>ZIP ‚Üí County ‚Üí State ‚Üí National]
    C --> D[Find Most Specific cost_dataset]
    
    %% Multi-Stakeholder Scenarios
    D --> E[Property Submission Created]
    E --> F[Multiple Buyer Scenarios]
    
    F --> G[Buyer A Scenario<br/>buyer_user_id: A]
    F --> H[Buyer B Scenario<br/>buyer_user_id: B]
    F --> I[Buyer C Scenario<br/>buyer_user_id: C]
    
    %% Row-Level Security
    G --> J[RLS Isolation<br/>Only Buyer A sees their data]
    H --> K[RLS Isolation<br/>Only Buyer B sees their data]
    I --> L[RLS Isolation<br/>Only Buyer C sees their data]
    
    %% Shared Property Data
    M[Shared Property Data<br/>submission_details<br/>submission_amenities<br/>submission_units] --> G
    M --> H
    M --> I
    
    %% Individual Cost Assumptions
    J --> N[Buyer A Report<br/>locked_dataset_id: X<br/>budget_tier: HIGH]
    K --> O[Buyer B Report<br/>locked_dataset_id: Y<br/>budget_tier: MEDIUM]
    L --> P[Buyer C Report<br/>locked_dataset_id: Z<br/>budget_tier: LOW]
    
    %% Comparable Analysis
    N --> Q[Comparative Analysis<br/>Same property, different assumptions<br/>Isolated yet comparable]
    O --> Q
    P --> Q
    
    %% Organization Sharing
    Q --> R[Organization Sharing<br/>submission_sharing table<br/>Access levels: view/edit/admin]
    
    %% Styling
    classDef property fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef geo fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef stakeholder fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef security fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef analysis fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    
    class A,B,E property
    class C,D geo
    class F,G,H,I,M stakeholder
    class J,K,L,N,O,P security
    class Q,R analysis
        </div>
        <div class="description">
            <strong>Multi-Stakeholder Innovation:</strong> Option C introduces industry-first multi-stakeholder support:
            <ul>
                <li><strong>Geographic Intelligence:</strong> Automatic resolution from property address to most specific cost dataset</li>
                <li><strong>Buyer Scenarios:</strong> Multiple buyers can analyze the same property with different cost assumptions</li>
                <li><strong>Row-Level Security:</strong> Complete data isolation ensures each buyer only sees their own analysis</li>
                <li><strong>Shared Foundation:</strong> Property details and amenities shared, but cost calculations isolated</li>
                <li><strong>Comparable Analysis:</strong> Teams can compare different buyer perspectives on the same deal</li>
                <li><strong>Organization Sharing:</strong> Flexible sharing with access level controls and expiration</li>
            </ul>
        </div>
    </div>

    <div class="diagram-container">
        <h2>Advanced Cost Calculation Engine</h2>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn('cost-engine')">+</button>
            <button class="zoom-btn" onclick="zoomOut('cost-engine')">-</button>
            <button class="zoom-btn" onclick="resetZoom('cost-engine')">Reset</button>
        </div>
        <div class="zoom-info">Use mouse wheel to zoom, drag to pan</div>
        <div class="mermaid" id="cost-engine">
flowchart LR
    %% Input Sources
    subgraph "Input Data Sources"
        A[Property Submission<br/>üìç Geographic location<br/>üè† Property characteristics]
        B[Amenity Selections<br/>üèä Pool: New Build<br/>üéæ Tennis Court: Renovate]
        C[Unit Configurations<br/>üè¢ 50 units: 2BR/2BA<br/>üîß Full renovation needed]
        D[Exterior Details<br/>üèóÔ∏è Stucco facade<br/>üé® Repaint needed]
    end
    
    %% Geographic Resolution
    A --> E[Geographic Engine<br/>üåç geo_regions hierarchy<br/>üìä Find specific dataset]
    E --> F[Locked Dataset<br/>üîí Immutable pricing<br/>üìÖ Point-in-time snapshot]
    
    %% Cost Standards Application
    B --> G[Amenity Cost Engine<br/>üìã amenity_master lookup<br/>‚öôÔ∏è Condition-based pricing]
    C --> H[Unit Cost Engine<br/>üè† Unit type standards<br/>üìè SF-based calculations]
    D --> I[Exterior Cost Engine<br/>üé® Material-based pricing<br/>üìê Area calculations]
    
    %% Bundle Processing
    G --> J[Bundle Expansion<br/>üì¶ cost_bundles<br/>üßÆ Dynamic formulas]
    H --> J
    I --> J
    
    %% Standards & Multipliers
    F --> K[Apply Standards<br/>üìä cost_item_standards<br/>‚è±Ô∏è Time, SF, crew data]
    J --> K
    K --> L[Regional Multipliers<br/>üåé Labor adjustments<br/>üí∞ Material variations]
    
    %% Budget Tier Selection
    L --> M[Budget Tier Engine<br/>üíé HIGH: Premium brands<br/>üí∞ MEDIUM: Standard quality<br/>üîß LOW: Value engineering]
    
    %% Final Calculations
    M --> N[Line Item Generation<br/>üìù Detailed calculations<br/>üîç Complete metadata]
    N --> O[Section Totals<br/>üìä Pre-calculated sums<br/>‚ö° Performance optimized]
    O --> P[Project Summary<br/>üí∞ Total project cost<br/>üìà ROI metrics<br/>üìÖ Timeline estimates]
    
    %% Immutable Output
    P --> Q[Lock Report<br/>üîí Immutable snapshot<br/>üìã Audit trail complete]
    
    %% Styling
    classDef input fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef geo fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef engine fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef processing fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef calculation fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef output fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    
    class A,B,C,D input
    class E,F geo
    class G,H,I,J engine
    class K,L,M processing
    class N,O,P calculation
    class Q output
        </div>
        <div class="description">
            <strong>Advanced Cost Calculation Engine:</strong> Option C provides the most sophisticated cost calculation system:
            <ul>
                <li><strong>Multi-Source Input:</strong> Property, amenity, unit, and exterior data all contribute to calculations</li>
                <li><strong>Geographic Intelligence:</strong> Automatic dataset resolution based on property location</li>
                <li><strong>Condition-Based Pricing:</strong> Amenities priced differently based on their current condition</li>
                <li><strong>Bundle System:</strong> Complex assemblies with dynamic quantity formulas</li>
                <li><strong>Standards Application:</strong> SF, time, and crew standards ensure accurate estimates</li>
                <li><strong>Regional Adjustments:</strong> Labor and material multipliers for local market conditions</li>
                <li><strong>Budget Tier Flexibility:</strong> Five budget levels from value engineering to luxury</li>
                <li><strong>Performance Optimization:</strong> Pre-calculated totals for sub-3-second report generation</li>
            </ul>
        </div>
    </div>

    <div class="diagram-container">
        <h2>Immutability & Audit Trail Framework</h2>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn('immutability')">+</button>
            <button class="zoom-btn" onclick="zoomOut('immutability')">-</button>
            <button class="zoom-btn" onclick="resetZoom('immutability')">Reset</button>
        </div>
        <div class="zoom-info">Use mouse wheel to zoom, drag to pan</div>
        <div class="mermaid" id="immutability">
flowchart TD
    %% Data Creation Phase
    A[Cost Data Import] --> B[Create cost_dataset<br/>version: 1, is_active: true]
    B --> C[Populate cost_prices<br/>Pricing by item + tier]
    C --> D[Lock Dataset<br/>locked_at: timestamp]
    
    %% Submission Phase
    E[Property Submission] --> F[Lock Dataset Reference<br/>locked_dataset_id]
    F --> G[Create Submission Details<br/>All property characteristics]
    G --> H[Version Control<br/>submission version tracking]
    
    %% Report Generation Phase
    H --> I[Generate Report<br/>Multiple report types]
    I --> J[Create Line Items<br/>unit_cost from locked dataset]
    J --> K[Calculate Totals<br/>Pre-computed for performance]
    K --> L[Lock Report<br/>locked_at: timestamp]
    
    %% Immutability Enforcement
    D --> M[Dataset IMMUTABLE<br/>‚ùå No updates allowed]
    L --> N[Report IMMUTABLE<br/>‚ùå No modifications allowed]
    
    %% Audit Trail
    M --> O[Complete Audit Trail<br/>‚úÖ Who, what, when, why]
    N --> O
    O --> P[Regulatory Compliance<br/>‚úÖ Financial audit ready]
    
    %% Version Management
    P --> Q[Version Tracking<br/>‚úÖ Historical preservation]
    Q --> R{Need Changes?}
    R -->|Yes| S[Create New Version<br/>Increment version number]
    R -->|No| T[Maintain Current<br/>Continue operations]
    
    S --> B
    T --> U[Operational Excellence<br/>‚úÖ Consistent, reliable data]
    
    %% Change Scenarios
    V[Market Conditions Change] --> W[Create regional_multipliers<br/>Quick adjustments]
    W --> X[No dataset recreation needed<br/>Rapid market response]
    
    Y[Cost Item Updates] --> Z[Create new cost_item version<br/>Preserve existing references]
    Z --> AA[Old reports unaffected<br/>New reports use new version]
    
    %% Styling
    classDef creation fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef submission fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef report fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef immutable fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    classDef audit fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef version fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    classDef change fill:#fff8e1,stroke:#fbc02d,stroke-width:2px
    
    class A,B,C,D creation
    class E,F,G,H submission
    class I,J,K,L report
    class M,N immutable
    class O,P,Q audit
    class R,S,T,U version
    class V,W,X,Y,Z,AA change
        </div>
        <div class="description">
            <strong>Comprehensive Immutability Framework:</strong> Option C provides industry-leading audit trail capabilities:
            <ul>
                <li><strong>Dataset Immutability:</strong> Cost datasets locked after creation, ensuring pricing consistency</li>
                <li><strong>Report Immutability:</strong> Reports locked after generation, preserving point-in-time calculations</li>
                <li><strong>Complete Audit Trail:</strong> Every change tracked with user, timestamp, and reason</li>
                <li><strong>Version Control:</strong> Comprehensive versioning across all major entities</li>
                <li><strong>Regulatory Compliance:</strong> Audit trails meet financial and regulatory requirements</li>
                <li><strong>Change Management:</strong> New versions created for changes, old data preserved</li>
                <li><strong>Market Responsiveness:</strong> Regional multipliers enable quick adjustments without dataset recreation</li>
            </ul>
        </div>
    </div>

    <script>
        // Store zoom instances
        const zoomInstances = {};
        
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'default',
            themeVariables: {
                primaryColor: '#2196F3',
                primaryTextColor: '#000',
                primaryBorderColor: '#1976D2',
                lineColor: '#757575',
                secondaryColor: '#FFC107',
                tertiaryColor: '#4CAF50'
            }
        });

        // Function to initialize zoom for a diagram
        function initializeZoom(diagramId) {
            const element = document.getElementById(diagramId);
            const svg = element.querySelector('svg');
            
            if (svg && !zoomInstances[diagramId]) {
                zoomInstances[diagramId] = svgPanZoom(svg, {
                    zoomEnabled: true,
                    controlIconsEnabled: false,
                    fit: true,
                    center: true,
                    minZoom: 0.1,
                    maxZoom: 10,
                    zoomScaleSensitivity: 0.2,
                    dblClickZoomEnabled: true,
                    mouseWheelZoomEnabled: true,
                    preventMouseEventsDefault: true,
                    contain: false,
                    viewportSelector: '.svg-pan-zoom-viewport',
                    beforeZoom: function(oldZoom, newZoom) {
                        updateZoomInfo(diagramId, newZoom);
                        return true;
                    }
                });
                
                // Force proper initial view
                setTimeout(() => {
                    if (zoomInstances[diagramId]) {
                        zoomInstances[diagramId].resize();
                        zoomInstances[diagramId].fit();
                        zoomInstances[diagramId].center();
                    }
                }, 50);
            }
        }

        // Update zoom level display
        function updateZoomInfo(diagramId, zoomLevel) {
            const container = document.getElementById(diagramId).closest('.diagram-container');
            const zoomInfo = container.querySelector('.zoom-info');
            if (zoomInfo) {
                zoomInfo.textContent = `Use mouse wheel to zoom, drag to pan | Zoom: ${Math.round(zoomLevel * 100)}%`;
            }
        }

        // Zoom control functions
        function zoomIn(diagramId) {
            if (zoomInstances[diagramId]) {
                zoomInstances[diagramId].zoomIn();
            }
        }

        function zoomOut(diagramId) {
            if (zoomInstances[diagramId]) {
                zoomInstances[diagramId].zoomOut();
            }
        }

        function resetZoom(diagramId) {
            if (zoomInstances[diagramId]) {
                zoomInstances[diagramId].resetZoom();
                zoomInstances[diagramId].center();
                zoomInstances[diagramId].fit();
            }
        }

        // Resize handler to maintain proper fit
        function handleResize() {
            Object.keys(zoomInstances).forEach(diagramId => {
                if (zoomInstances[diagramId]) {
                    setTimeout(() => {
                        zoomInstances[diagramId].resize();
                        zoomInstances[diagramId].fit();
                        zoomInstances[diagramId].center();
                    }, 100);
                }
            });
        }

        // Wait for DOM to load, then render diagrams
        document.addEventListener('DOMContentLoaded', function() {
            const diagrams = ['schema-erd', 'data-flow', 'multi-stakeholder', 'cost-engine', 'immutability'];
            let renderCount = 0;
            
            diagrams.forEach(diagramId => {
                const element = document.getElementById(diagramId);
                const diagramDefinition = element.textContent.trim();
                
                mermaid.render(`${diagramId}-svg`, diagramDefinition).then(function(result) {
                    // Create a wrapper div for proper sizing
                    const wrapper = document.createElement('div');
                    wrapper.style.width = '100%';
                    wrapper.style.height = '100%';
                    wrapper.style.position = 'relative';
                    wrapper.innerHTML = result.svg;
                    
                    element.innerHTML = '';
                    element.appendChild(wrapper);
                    
                    // Ensure the SVG fills the container properly
                    const svg = wrapper.querySelector('svg');
                    if (svg) {
                        // Get the original viewBox or create one
                        let viewBox = svg.getAttribute('viewBox');
                        if (!viewBox) {
                            const bbox = svg.getBBox();
                            viewBox = `0 0 ${bbox.width || 1000} ${bbox.height || 800}`;
                            svg.setAttribute('viewBox', viewBox);
                        }
                        
                        // Set SVG to fill container
                        svg.setAttribute('width', '100%');
                        svg.setAttribute('height', '100%');
                        svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                        svg.style.width = '100%';
                        svg.style.height = '100%';
                        svg.style.position = 'absolute';
                        svg.style.top = '0';
                        svg.style.left = '0';
                    }
                    
                    // Initialize zoom after a short delay to ensure SVG is fully rendered
                    setTimeout(() => {
                        initializeZoom(diagramId);
                        renderCount++;
                        
                        // Update zoom info for all diagrams once all are rendered
                        if (renderCount === diagrams.length) {
                            diagrams.forEach(id => updateZoomInfo(id, 1));
                        }
                    }, 300);
                }).catch(function(error) {
                    console.error(`Error rendering diagram ${diagramId}:`, error);
                    element.innerHTML = `<p style="color: red;">Error rendering diagram: ${error.message}</p>`;
                });
            });
            
            // Add resize event listener
            window.addEventListener('resize', handleResize);
        });
    </script>
</body>
</html> 